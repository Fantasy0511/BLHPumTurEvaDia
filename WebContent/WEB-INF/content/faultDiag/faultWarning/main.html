<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>故障预警</title>

<link rel="stylesheet"
	href="/BLHPumTurEvaDia/tool/easyui-1.4.5/themes/default/easyui.css">
<link rel="stylesheet" type="text/css"
	href="/BLHPumTurEvaDia/tool/easyui-1.4.5/themes/icon.css">
<link rel="stylesheet" type="text/css"
	href="/BLHPumTurEvaDia/css/assess/inputdiv.css">
<link rel="stylesheet" type="text/css"
	href="/BLHPumTurEvaDia/js/assess/icon.css">
<link rel="stylesheet" type="text/css"
	href="/BLHPumTurEvaDia/css/assess/assesment.css">
<link rel="stylesheet"
	href="/BLHPumTurEvaDia/tool/dataTable/jquery.dataTables.min.css">
<link rel="stylesheet"
	href="/BLHPumTurEvaDia/tool/bootstrap/dist/css/bootstrap.min.css">
	
<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/jquery/jquery.min.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/easyui-1.4.5/jquery.easyui.min.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/easyui-1.4.5/locale/easyui-lang-zh_CN.js"></script>


<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/dataTable/jquery.dataTables.min.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/js/assess/lodash.min.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/js/assess/easyui-util-all.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/js/highcharts_util.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/js/assess/highcharts.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/highcharts/highcharts-more.js"></script>

<script type="text/javascript"
	src="/BLHPumTurEvaDia/js/warningChart/echarts.min.js"></script>
</head>
<script type="text/javascript">
	function myformatter(date) {
		var y = date.getFullYear();
		var m = date.getMonth() + 1;
		var d = date.getDate();
		return y + '-' + (m < 10 ? ('0' + m) : m) + '-'
				+ (d < 10 ? ('0' + d) : d);
	}
	function myparser(s) {
		if (!s)
			return new Date();
		var ss = (s.split('-'));
		var y = parseInt(ss[0], 10);
		var m = parseInt(ss[1], 10);
		var d = parseInt(ss[2], 10);
		if (!isNaN(y) && !isNaN(m) && !isNaN(d)) {
			return new Date(y, m - 1, d);
		} else {
			return new Date();
		}
	}
</script>
<script type="text/javascript">
	var table = $('#historyTable').DataTable();
	function faultWarning() {
		
		table.destroy();
		var system = $('#subSystem').combobox('getText'); //把前端选择的子系统传给“system”
		var starTime = getComboboxValue("startTime");
		var endTime = getDate("endTime");
		var url1 = "/BLHPumTurEvaDia/datamine/history/query-fault-history?inputStr="
				+ system + "//" + starTime + "//" + endTime; //将某个子系统历史数据的地址传给url1
				
		console.log(url1);
				
				
		/* $.getJSON(url1, function(data) {
			var rows = data.historyTable;
			loadData('historyTable', rows);
		}); */
		
		
		//***上面的代码已经将前端数据传到后台了，下面开始后端回调到前端***//
		table = $('#historyTable').DataTable({             /* json数组 */
			"iDisplayLength": 3,
	        "lengthMenu": [[3, 6, 9, -1], [3, 6, 9, "所有"]],
			"bAutoWidth":true,
	        ajax : {url : url1},
			columns : [ 
				//JSON语句+数组               columns:纵列
				{"data" : "faultName",  orderable:false}, 
				{"data" : "paramters", orderable:false} 
				],
			/* "columnDefs" : [ { //datatable 用columnDefs 接收数组列以及datatable 动态传url
			// "visible": false,
			//"targets": 0
			}, 
			{
				"render" : function(data, type, row, meta) { //render:表达/传递，row:行
					return '<a>' + row.paramters + '</a>';
				},
				"targets" : 3//targets参数设置一个列或者多列
			} ], */
			searching:false, //去掉搜索框
		    bLengthChange:false,//去掉每页多少条框体
			"language": {
                "lengthMenu": "每页 _MENU_ 条记录",
                "zeroRecords": "抱歉，没有找到",
                "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
                "infoEmpty": "无记录",
                "infoFiltered": "(从 _MAX_ 条记录过滤)",
                "sSearch": "模糊查询:  ",
	            "oPaginate": {
	                "sPrevious": "前一页",
	                "sNext": "后一页",
	            }
            }
		});
		
		
	}

	//***上面的代码实现了历史数据的调出，下面的代码实现某一故障，鼠标点上去，以调出相应的图表Chart***//
	
	$(document).ready(function() {
		 $('#historyTable tbody').on('mouseover', 'tr', //mouseover：鼠标移上字体时。（jQuery 事件 - mouseout() 方法）
		      function() {
						   $(this).toggleClass('selected');
						  });
		 $('#historyTable tbody').on('mouseout', 'tr',
			  function() {
						   $(this).toggleClass('selected');
					      });
		 $('#historyTable tbody').on('click','tr', //mouseout：当鼠标指针从元素上移开时，发生 mouseout 事件，改变元素的背景色 
			  function() {
					var url = "/BLHPumTurEvaDia/datamine/history/view-parameter-curve?inputStr=";
					// $(this).toggleClass('selected');
					var data = table.row('.selected')
					.data(); //将前端点击的行的选择传给参数“data”
					var start = data.startTimeString; //将选中那行的元素--开始时间传给“start”
					var end = data.endTimeString; //将选中那行的元素--结束时间传给“end”
					var para = data.paramters; //将选中那行的元素--参数传给“para”
					console.log(para); //传递成功显示“para”
					var titleChart = para.split(" ");
					
					url = url + start + "//" + end
					+ "//" + para; //重新定义了传入地址url
					console.log(url);
					var chart1 = Highcharts.chart;
					$.getJSON(url,
							function(result) { //调用url地址json数据，加载成功执行回调函数result
									options1.series[0].data = result.data1.value;
									options1.series[0].name = titleChart[0];
									chart1 = new Highcharts.Chart(options1);
									chart1.series[0].update(options1.series[0].data);
													});

									var options1 = {
									    chart : {
											renderTo : 'container1', //生成的故障图1扔进“container1”里
											type : 'spline'
											},
											series : [ {} ],
											title : null,
											xAxis: {
										        lineWidth: 2,
										        lineColor:'black',
										        gridLineColor:'#A0A0A0',
										        gridLineDashStyle:'dash',
										        minorGridLineWidth: 0,
										        minorTickLength:5,
										        minorTickInterval: 'auto',
										        minorTickPosition: 'outside',
										        minorTickWidth: 1
										    },
										    yAxis: {
										    	title:{
										    		text:null
										    	},
										        lineWidth: 2,
										        lineColor:'black',
										        gridLineColor:'#A0A0A0',
										        gridLineDashStyle:'dash',
										        minorGridLineWidth: 0,
										        minorTickLength:5,
										        minorTickInterval: 'auto',
										        minorTickPosition: 'outside',
										        minorTickWidth: 1
										    },
											credits : {
											enabled : false
												}
											};
										});
					});

	$(function() {
		$("#bt_warning").click(faultWarning);
	});
</script>

<body>
	<div class="input_div" style="margin-bottom: 5px;">
		<span class="input_title">条件输入：</span> <label
			style="margin-bottom: 5px">开始时间：</label><input id="startTime"
			class="easyui-datebox" required style="width: 150px; height: 26px">
		<label style="margin-bottom: 5px">结束时间：</label><input id="endTime"
			class="easyui-datebox" required style="width: 150px; height: 26px">
		<script>
			$.extend($.fn.validatebox.defaults.rules, {
				md : {
					validator : function(value, param) {
						var d1 = $.fn.datebox.defaults.parser(param[0]);
						var d2 = $.fn.datebox.defaults.parser(value);
						return d2 >= d1;
					},
					message : '结束时间必须大于或等于开始时间。'
				}
			})
		</script>
		<label for="model">系统选择：</label> <select id="subSystem"
			class="easyui-combobox" style="width: 140px;">
			<option value="Gov">球阀系统</option>
			<option value="Pum">发电机及励磁系统</option>
			<option value="ball">调速器系统</option>
			<option value="Exc">主变系统</option>
			<option value="Transfer">水泵水轮机</option>
		</select> <a id="bt_warning" href="#" class="easyui-linkbutton"
			data-options="iconCls:'icon-ok'">开始查询</a>
	</div>

	<div style="margin-left: 2%; margin-right: 2%; width: 100%">
		<div style="width:47%;height: auto; float:left; display:inline;margin-right: 2%">
		<div class="easyui-panel" title="历史运行状态数据"
			style="width: 100%; height: 400px;">
			<div>
				<table class="table" id="historyTable" border="1" style="text-align:left" >
					<thead>
						<tr>
							<th >故障名称</th>
							<th >关联参数</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>
		</div>
		
		<div style="width:45%;height: auto; float:left; display:inline">
		<div class="easyui-panel" title="运行状态数据图"
			style="width: 100%; height: 400px;">
			<div id="container1" style="height:100%">
				<pre>    暂无结果</pre>
			</div>
		</div>
		</div>
		
	</div>

	<div class="ipad" style="height: 30px"></div>

	
	<div style="margin-left: 2%; margin-right: 2%; width: 100%;height: 450px">
		<div class="easyui-panel" title="预警结果分析图"
			style="width: 94%; height:450px">
			<div class=“easyui-layout” data-option="fit:true">
				<div id="container3" style="width: 55%; height: 380px;float:left;margin-right: 2%"></div>
				<div style="width: 40%; height: 380px;float:left; ">
					<div class="easyui-panel" title="评价与建议"  style="width: 100%; height: 380px ">
						<table border="1" style="height: 300px ;width: 50%;float:left;margin-right: 4%">
							<tr>
								<th >故障名称</th>
								<th>概率</th>
							</tr>
							<tr>
								<td >油路压力</td>
								<td>10.2%</td>
							</tr>
							<tr>
								<td>冷却水流量</td>
								<td>9.44%</td>
							</tr>
							<tr>
								<td>水温</td>
								<td>7.13%</td>
							</tr>
							<tr>
								<td>油位</td>
								<td>4.11%</td>
							</tr>
							<tr>
								<td>磨损情况</td>
								<td>30.45%</td>
							</tr>
							<tr>
								<td>水导X轴振动</td>
								<td>4.11%</td>
							</tr>
							<tr>
								<td>水导Y轴振动</td>
								<td>30.45%</td>
							</tr>
							<tr>
								<td>水导Z轴振动</td>
								<td>4.11%</td>
							</tr>

						</table>
						<table border="1" style="height: 300px; width: 35%">
							<tr>
								<td>评价与建议</td>
							</tr>
						</table>
					</div>
				</div>
			</div>
		</div>

	</div>
	
<script type="text/javascript">
	var dom = document.getElementById("container3");
	var myChart = echarts.init(dom);
	var app = {};
	option = null;
	option = {
	    title : {
	        text: '预警结果分析',
	        subtext: false,
	        x:'center'
	    },
	    tooltip : {
	        trigger: 'item',
	        formatter: "{a} <br/>{b} : {c} ({d}%)"
	    },
	    legend: {
	        orient: 'vertical',
	        left: 'left',
	        data: ['油路压力','冷却水流量','水温','油位','磨损情况','水导X轴振动','水导Y轴振动','水导Z轴振动']
	    },
	    series : [
	        {
	            name: '故障类别',
	            type: 'pie',
	            radius : '55%',
	            center: ['50%', '60%'],
	            data:[
	                {value:335, name:'油路压力'},
	                {value:310, name:'冷却水流量'},
	                {value:234, name:'水温'},
	                {value:135, name:'油位'},
	                {value:1000, name:'磨损情况'},
	                {value:135, name:'水导X轴振动'},
	                {value:1000, name:'水导Y轴振动'},
	                {value:135, name:'水导Z轴振动'},
	            ],
	            itemStyle: {
	                emphasis: {
	                    shadowBlur: 10,
	                    shadowOffsetX: 0,
	                    shadowColor: 'rgba(0, 0, 0, 0.5)'
	                }
	            }
	        }
	    ]
	};
	;
	if (option && typeof option === "object") {
	    myChart.setOption(option, true);
	}
	</script>



</body>
</html>