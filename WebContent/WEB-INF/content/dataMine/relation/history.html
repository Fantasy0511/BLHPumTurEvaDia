<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>历史查询</title>

<link rel="stylesheet"
	href="/BLHPumTurEvaDia/tool/easyui-1.4.5/themes/default/easyui.css">
<link rel="stylesheet" type="text/css"
	href="/BLHPumTurEvaDia/tool/easyui-1.4.5/themes/icon.css">
<link rel="stylesheet" type="text/css"
	href="/BLHPumTurEvaDia/css/assess/inputdiv.css">
<link rel="stylesheet" type="text/css"
	href="/BLHPumTurEvaDia/js/assess/icon.css">
<link rel="stylesheet" type="text/css"
	href="/BLHPumTurEvaDia/css/assess/assesment.css">
<link rel="stylesheet"
	href="/BLHPumTurEvaDia/tool/dataTable/jquery.dataTables.min.css">
<link rel="stylesheet"
	href="/BLHPumTurEvaDia/tool/bootstrap/dist/css/bootstrap.min.css"> 
<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/jquery/jquery.min.js" charset="UTF-8"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/easyui-1.4.5/jquery.easyui.min.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/easyui-1.4.5/locale/easyui-lang-zh_CN.js"></script>

<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/js/assess/lodash.min.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/js/assess/easyui-util-all.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/js/echarts.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/dataTable/jquery.dataTables.min.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/highcharts/highcharts.js"></script>
<script type="text/javascript"
	src="/BLHPumTurEvaDia/tool/highcharts/highcharts-more.js"></script>
</head>
<style>
.page_operation_bar {
	height: 50px;
	width: 97%;
	margin: 10px;
	background-color: #d9edf7;
	border-radius: 15px 5px;
}

#showDiv {
	width: 100%;
	height: 7.2%;
	font-size: 16px;
	padding-top: 0.6%;
}

.form-group {
	
}
</style>
<script type="text/javascript">
	var table = $('#historyTable').DataTable();//jQuery dataTable（表格解决方案）的初始化
	
	function queryHistory() { //queryHistory()查询方法
		table.destroy(); //表格销毁
		var system = $("#subSystem").combobox("getValue"); //把前端选择的子系统传给“system”
		var starTime = getDate("startTime");
		var endTime = getDate("endTime");

		var url1 = "/BLHPumTurEvaDia/datamine/history/query-fault-history?inputStr="
				+ system + "//" + starTime + "//" + endTime; //将某个子系统历史数据的地址传给url1
		console.log(url1);//传递成功显示“url1”

		//***dataTable的基本设置   start***//
		table = $('#historyTable').DataTable({ /* json数组 */
			"iDisplayLength" : 3,
			"lengthMenu" : [ [ 3, 6, 18, -1 ], [ 3, 6, 18, "所有" ] ],
			"bAutoWidth" : true,
			ajax : {
				url : url1
			},
			columns : [ {
				"data" : "faultID",
				orderable : false
			},//JSON语句+数组               columns:纵列
			{
				"data" : "system",
				orderable : false
			}, {
				"data" : "faultName",
				orderable : false
			}, {
				"data" : "faultReason",
				orderable : false
			}, {
				"data" : "startTimeString",
				orderable : false
			}, {
				"data" : "endTimeString",
				orderable : false
			}, {
				"data" : "workConditon",
				orderable : false
			}, {
				"data" : "paramters",
				orderable : false
			} ],
			"columnDefs" : [ { //datatable 用columnDefs 接收数组列以及datatable 动态传url
			// "visible": false,
			//"targets": 0
			}, {
				"render" : function(data, type, row, meta) { //render:表达/传递，row:行
					return '<a>' + row.paramters + '</a>';
				},
				"targets" : 7
			//targets参数设置一个列或者多列
			} ],
			"sPaginationType" : "simple_numbers",
			searching : false, //去掉搜索框
			bLengthChange : false,//去掉每页多少条框体
			"language" : {
				"lengthMenu" : "每页 _MENU_ 条记录",
				"zeroRecords" : "抱歉，没有找到",
				"info" : "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
				"infoEmpty" : "无记录",
				"infoFiltered" : "(从 _MAX_ 条记录过滤)",
				"sSearch" : "模糊查询:  ",
				"oPaginate" : {
					"sPrevious" : "前一页",
					"sNext" : "后一页",
				}
			},
			"bDestroy": true
		});
		//***dataTable的基本设置   end***//
		
	}
	
	//** 点击历史状态查询模块按钮，调一次历史数据表
	function showHistoryTable() {
		
		var table = $('#historyTable').DataTable();
		var system = "Transfer";
		var starTime = "2015-01-1";
		var endTime = "2018-01-01";
		var url2 = "/BLHPumTurEvaDia/datamine/history/query-fault-history?inputStr="
				+ system + "//" + starTime + "//" + endTime;
		console.log(url2);
		table = $('#historyTable').DataTable({ /* json数组 */
			"iDisplayLength" : 3,
			"lengthMenu" : [ [ 3, 6, 18, -1 ], [ 3, 6, 18, "所有" ] ],
			"bAutoWidth" : true,
			ajax : {
				url : url2
			},
			columns : [ {
				"data" : "faultID",
				orderable : false
			},//JSON语句+数组               columns:纵列
			{
				"data" : "system",
				orderable : false
			}, {
				"data" : "faultName",
				orderable : false
			}, {
				"data" : "faultReason",
				orderable : false
			}, {
				"data" : "startTimeString",
				orderable : false
			}, {
				"data" : "endTimeString",
				orderable : false
			}, {
				"data" : "workConditon",
				orderable : false
			}, {
				"data" : "paramters",
				orderable : false
			} ],
			"columnDefs" : [ { //datatable 用columnDefs 接收数组列以及datatable 动态传url
			// "visible": false,
			//"targets": 0
			}, {
				"render" : function(data, type, row, meta) { //render:表达/传递，row:行
					return '<a>' + row.paramters + '</a>';
				},
				"targets" : 7
			//targets参数设置一个列或者多列
			} ],
			"sPaginationType" : "simple_numbers",
			searching : false, //去掉搜索框
			bLengthChange : false,//去掉每页多少条框体
			"language" : {
				"lengthMenu" : "每页 _MENU_ 条记录",
				"zeroRecords" : "抱歉，没有找到",
				"info" : "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
				"infoEmpty" : "无记录",
				"infoFiltered" : "(从 _MAX_ 条记录过滤)",
				"sSearch" : "模糊查询:  ",
				"oPaginate" : {
					"sPrevious" : "前一页",
					"sNext" : "后一页",
				}
			},
			"bDestroy": true
		});
	};
	
	
	var myChart;
	
	//***某一故障，鼠标点上去，以调出相应的图表Chart***//
	$(document).ready(function() {
						$('#historyTable tbody').on('mouseover', 'tr', //mouseover：鼠标移上字体时。（jQuery 事件 - mouseout() 方法）
						function() {
							$(this).toggleClass('selected');
						});
						$('#historyTable tbody').on('mouseout', 'tr',
								function() {
									$(this).toggleClass('selected');
								});
						$('#historyTable tbody')
								.on('click','tr', //mouseout：当鼠标指针从元素上移开时，发生 mouseout 事件，改变元素的背景色 
										function() {
											var url = "/BLHPumTurEvaDia/datamine/history/view-parameter-curve?inputStr=";
											// $(this).toggleClass('selected');
											var data = table.row('.selected').data(); //将前端点击的行的选择传给参数“data”
											var start = data.startTimeString; //将选中那行的元素--开始时间传给“start”
											var end = data.endTimeString; //将选中那行的元素--结束时间传给“end”
											var para = data.paramters; //将选中那行的元素--参数传给“para”
											console.log(para); //传递成功显示“para”
											var titleChart = para.split(" ");
											

											url = url + start + "//" + end
													+ "//" + para; //重新定义了传入地址url
											console.log(url);
													
											
											$.getJSON(url,function(result) { //调用url地址json数据，加载成功执行回调函数result
														time= result.data1.time;
														data=result.data1.value;
														var temp=result.typeid1;
											
											
											if(temp.indexOf("bool")!=-1){    //开关量和状态量进行判断，更换图标类型，和坐标轴名称
															var stepType='middle';
															yAxisName='开关量';
														}
											else{
															stepType=false;
															yAxisName='状态量';
														} ;
														
											if(myChart !=null && myChart !=""&& myChart !=undefined){
												myChart.dispose();
											}
											myChart = echarts.init(document.getElementById('chartmain')); 
											
											var timeData =  time,
											timeData = timeData.map(function (str) {
											        return str.substring(5, 19);
											    });
											
											
											 option = {
											        title: {
											            text:  titleChart[0],
											            x: 'center'
											        },
											        tooltip: {
											            trigger: 'axis',
											            axisPointer: {
											                animation: false
											            }
											        },
											        legend: {
											            data:['历史查询数据'],
											            x: 'left',
											            itemHeight:20
											        },
											        toolbox: {
											            feature: {
											                /* dataZoom: {
											                    yAxisIndex: 'none'
											                },
											                restore: {}, */
											                saveAsImage: {}
											            },
											            right:'8%'
											        },

											        dataZoom: [
											            {
											                show: true,
											                realtime: true,
											                start: 0,
											                end: 100,
											                xAxisIndex: [0]
											            },
											            {
											                type: 'inside',
											                realtime: true,
											                start: 0,
											                end: 100,
											                xAxisIndex: [0]
											            }
											        ],
											        grid: [{
											            left:'5%',
											            right: '8%',
											            height: '70%'
											        }],
											        xAxis : [
											            {
											                name : '时间',
											                type : 'category',
											                boundaryGap : false,
											                axisLine: {onZero: true},
											                data: timeData
											            }
											        ],
											        yAxis : [
											            {
											                name : yAxisName,
											                type : 'value',
											                max :  function(value) {
											                    return (value.max).toFixed(1) ;
											                },
											                min :  function(value) {
											                    return (0.8*value.min).toFixed(1) ;
											                }
											            }
											        ],
											        series : [
											            {
											                step: stepType,
											            	name:'历史查询数据',
											                type:'line',
											                symbolSize: 8,
											                hoverAnimation: false,
											                data: data,
											                itemStyle : {
											                        normal : {
											                            lineStyle:{
											                                width:2,//折线宽度
											                                color:"#1c73c1"//折线颜色
											                            }
											                        }
											                    }
											            }
											        ]
											    };
											    myChart.clear();
											   
											    myChart.setOption(option);
											
											});
										});
					});
	
	

	
	$(function() {
		showHistoryTable();
		$("#btn_query").click(queryHistory);
		 
	});
</script>

<body>
	<div class="input_div" style="margin-bottom: 5px;margin-top: 5px;margin-left:auto;margin-right:auto;width:94%">
		<span class="input_title">条件输入：</span> <label
			style="margin-bottom: 5px">开始时间：</label><input id="startTime"
			class="easyui-datebox" required style="width: 150px; height: 26px">
		<label style="margin-bottom: 5px">结束时间：</label><input id="endTime"
			class="easyui-datebox" required style="width: 150px; height: 26px">
		<script>
			$.extend($.fn.validatebox.defaults.rules, {
				md : {
					validator : function(value, param) {
						var d1 = $.fn.datebox.defaults.parser(param[0]);
						var d2 = $.fn.datebox.defaults.parser(value);
						return d2 >= d1;
					},
					message : '结束时间必须大于或等于开始时间。'
				}
			})
		</script>
		<label for="model">子系统选择：</label> <select id="subSystem"
			class="easyui-combobox" style="width: 140px;">
			<option value="Pum">水泵水轮机</option>
			<option value="ball">球阀系统</option>
			<option value="Exc">发电机及励磁系统</option>
			<option value="Gov">调速器系统</option>
			<option value="Transfer">主变系统</option>
		</select> <a id="btn_query" href="#" class="easyui-linkbutton"
			data-options="iconCls:'icon-ok'"> 查询 </a>
	</div>

	<div style="margin-left: auto; margin-right: auto; width: 94%">
		<div class="easyui-panel" title="历史运行状态数据"
			style="width: 100%; height: auto;">
			<div>
				<table class="table" id="historyTable"
					style="text-align: left; width: 100%; height: auto; margin-left: auto; margin-right: auto">
					<thead>
						<tr>
							<th style="width: 7%">故障ID</th>
							<th style="width: 9%">子系统</th>
							<th style="width: 9%">故障名称</th>
							<th style="width: 34%">故障原因</th>
							<th style="width: 8%">开始时间</th>
							<th style="width: 8%">结束时间</th>
							<th style="width: 8%">工况</th>
							<th style="width: 17%">关联参数</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>
	</div>

	<div class="ipad" style="height: 20px"></div>

	<div style="margin-left: auto; margin-right: auto; width: 94%">
		<div
			style="width: 100%; height: auto; float: left; display: inline; margin-right: 2%">
			<div style="width: 100%; height: auto; float: left; display: inline">
				<div class="easyui-panel" title="故障趋势图"
					style="width: 100%; height: 600px;">
					<div id="chartmain" style="height: 100%">
						<pre>    暂无结果</pre>
					</div>
				</div>
			</div>
		</div>
		<!-- <div style="width: 49%; height: auto; float: left; display: inline">
			<div class="easyui-panel" title="故障趋势图"
				style="width: 100%; height: 400px;">
				<div id="container2" style="height: 100%">
					<pre>    暂无结果</pre>
				</div>
			</div>
		</div> -->
	</div>

	<!-- <script type="text/javascript">
		$('.form_date').datetimepicker({
			language : 'fr',
			weekStart : 1,
			todayBtn : 1,
			todayHighlight : 1,
			startView : 2,
			minView : 2,
			forceParse : 0,
			format : 'yyyy-mm-dd'
		});
	</script> -->
</body>
</html>